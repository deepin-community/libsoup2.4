From: Eugene Mutavchi <Ievgen_Mutavchi@comcast.com>
Date: Fri, 10 Oct 2025 16:24:27 +0000
Subject: fix 'heap-use-after-free' caused by 'finishing' queue item twice

---
 libsoup/soup-session.c | 6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

diff --git a/libsoup/soup-session.c b/libsoup/soup-session.c
index 83421ef..fcfcd21 100644
--- a/libsoup/soup-session.c
+++ b/libsoup/soup-session.c
@@ -4090,8 +4090,10 @@ try_run_until_read (SoupMessageQueueItem *item)
 		if (item->state != SOUP_MESSAGE_FINISHED) {
 			if (soup_message_io_in_progress (item->msg))
 				soup_message_io_finished (item->msg);
-			item->state = SOUP_MESSAGE_FINISHING;
-			soup_session_process_queue_item (item->session, item, NULL, FALSE);
+			if (item->state != SOUP_MESSAGE_FINISHED) {
+				item->state = SOUP_MESSAGE_FINISHING;
+				soup_session_process_queue_item (item->session, item, NULL, FALSE);
+			}
 		}
 		async_send_request_return_result (item, NULL, error);
 		return;
