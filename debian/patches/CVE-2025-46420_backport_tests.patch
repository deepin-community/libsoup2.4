From: Sean Whitton <spwhitton@spwhitton.name>
Date: Sat, 3 May 2025 17:04:55 +0800
Subject: Backport tests for CVE-2025-46420

---
 tests/multipart-test.c | 27 +++++++++++++++------------
 1 file changed, 15 insertions(+), 12 deletions(-)

diff --git a/tests/multipart-test.c b/tests/multipart-test.c
index c46b320..de1a369 100644
--- a/tests/multipart-test.c
+++ b/tests/multipart-test.c
@@ -485,16 +485,19 @@ test_multipart_bounds_good (void)
 	#define TEXT "line1\r\nline2"
 	SoupMultipart *multipart;
 	SoupMessageHeaders *headers, *set_headers = NULL;
-	GBytes *bytes, *set_bytes = NULL;
+	SoupMessageBody *body = NULL;
+	SoupBuffer *set_bytes = NULL;
 	const char *raw_data = "--123\r\nContent-Type: text/plain;\r\n\r\n" TEXT "\r\n--123--\r\n";
 	gboolean success;
 
 	headers = soup_message_headers_new (SOUP_MESSAGE_HEADERS_MULTIPART);
 	soup_message_headers_append (headers, "Content-Type", "multipart/mixed; boundary=\"123\"");
 
-	bytes = g_bytes_new (raw_data, strlen (raw_data));
+	body = soup_message_body_new ();
+	soup_message_body_append (body, SOUP_MEMORY_COPY,
+				  raw_data, strlen (raw_data));
 
-	multipart = soup_multipart_new_from_message (headers, bytes);
+	multipart = soup_multipart_new_from_message (headers, body);
 
 	g_assert_nonnull (multipart);
 	g_assert_cmpint (soup_multipart_get_length (multipart), ==, 1);
@@ -502,12 +505,11 @@ test_multipart_bounds_good (void)
 	g_assert_true (success);
 	g_assert_nonnull (set_headers);
 	g_assert_nonnull (set_bytes);
-	g_assert_cmpint (strlen (TEXT), ==, g_bytes_get_size (set_bytes));
+	g_assert_cmpint (strlen (TEXT), ==, set_bytes->length);
 	g_assert_cmpstr ("text/plain", ==, soup_message_headers_get_content_type (set_headers, NULL));
-	g_assert_cmpmem (TEXT, strlen (TEXT), g_bytes_get_data (set_bytes, NULL), g_bytes_get_size (set_bytes));
+	g_assert_cmpmem (TEXT, strlen (TEXT), set_bytes->data, set_bytes->length);
 
-	soup_message_headers_unref (headers);
-	g_bytes_unref (bytes);
+	soup_message_headers_free (headers);
 
 	soup_multipart_free (multipart);
 
@@ -519,20 +521,21 @@ test_multipart_bounds_bad (void)
 {
 	SoupMultipart *multipart;
 	SoupMessageHeaders *headers;
-	GBytes *bytes;
+	SoupMessageBody *body = NULL;
 	const char *raw_data = "--123\r\nContent-Type: text/plain;\r\nline1\r\nline2\r\n--123--\r\n";
 
 	headers = soup_message_headers_new (SOUP_MESSAGE_HEADERS_MULTIPART);
 	soup_message_headers_append (headers, "Content-Type", "multipart/mixed; boundary=\"123\"");
 
-	bytes = g_bytes_new (raw_data, strlen (raw_data));
+	body = soup_message_body_new ();
+	soup_message_body_append (body, SOUP_MEMORY_COPY,
+				  raw_data, strlen (raw_data));
 
 	/* it did read out of raw_data/bytes bounds */
-	multipart = soup_multipart_new_from_message (headers, bytes);
+	multipart = soup_multipart_new_from_message (headers, body);
 	g_assert_null (multipart);
 
-	soup_message_headers_unref (headers);
-	g_bytes_unref (bytes);
+	soup_message_headers_free (headers);
 }
 
 int
